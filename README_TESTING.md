# Руководство по тестированию астрологических расчетов

## Установка зависимостей для тестирования

```bash
pip install -r requirements.txt
```

## Запуск тестов

### Запуск всех тестов

```bash
pytest
```

### Запуск конкретного тестового файла

```bash
pytest tests/test_astro_service.py
pytest tests/test_known_charts.py
pytest tests/test_natal_chart_service.py
```

### Запуск с подробным выводом

```bash
pytest -v
```

### Запуск с выводом покрытия кода

```bash
pytest --cov=services --cov-report=html
```

## Структура тестов

### 1. `test_astro_service.py`
Основные тесты для `astro_service`:
- Расчет позиций планет
- Расчет домов
- Расчет аспектов
- Определение домов для планет
- Расчет полной натальной карты
- Расчет транзитов
- Преобразование градусов в знаки зодиака
- Граничные случаи

### 2. `test_known_charts.py`
Тесты с известными натальными картами для верификации точности:
- Верификация позиций планет через Swiss Ephemeris
- Проверка консистентности расчетов
- Проверка соответствия куспидов домов и углов
- Прямая верификация через Swiss Ephemeris

### 3. `test_natal_chart_service.py`
Тесты для бизнес-логики:
- Расчет и сохранение карт
- Получение карт из БД
- Обработка ошибок

## Тестовые данные

### Известные тестовые карты

В `tests/conftest.py` определены тестовые данные для известных карт:
- `test_chart_1`: 15 мая 1990, 14:30, Москва
- `test_chart_2`: 20 марта 1985, 12:00, Москва
- `test_chart_3`: 4 июля 1995, 10:15, Нью-Йорк

### Верификация через Swiss Ephemeris

Для верификации точности расчетов используются:
1. Прямые расчеты через Swiss Ephemeris (pyswisseph)
2. Сравнение результатов с известными астрологическими программами
3. Проверка консистентности между повторными расчетами

## Добавление новых тестов

### Тест для новой планеты

```python
def test_new_planet_position(self):
    jd = swe.julday(2000, 1, 1, 0.0, swe.GREG_CAL)
    position = astro_service._calculate_planet_position('new_planet', jd)
    assert position is not None
```

### Тест для новой системы домов

```python
def test_new_house_system(self):
    chart = astro_service.calculate_natal_chart(
        birth_date=date(2000, 1, 1),
        birth_time_utc=datetime(2000, 1, 1, 0, 0, 0, tzinfo=pytz.UTC),
        latitude=55.7558,
        longitude=37.6173,
        houses_system='new_system'
    )
    assert chart['success'] is True
```

## Верификация с внешними источниками

Для полной верификации рекомендуется:
1. Проверить расчеты через Swiss Ephemeris (официальный сайт)
2. Сравнить с результатами профессиональных астрологических программ
3. Проверить известные натальные карты известных людей

## Известные проблемы и ограничения

- Тесты используют приблизительные ожидаемые значения для некоторых позиций
- Для точной верификации необходимо проверять результаты через Swiss Ephemeris
- Некоторые тесты могут требовать настройки в зависимости от версии библиотек

## CI/CD интеграция

Для автоматического запуска тестов в CI/CD:

```yaml
# Пример для GitHub Actions
- name: Run tests
  run: |
    pip install -r requirements.txt
    pytest --cov=services --cov-report=xml
```

