import os
import json
import httpx
import asyncio
import logging
import threading
from pathlib import Path
from typing import Dict, List, Optional
from dotenv import load_dotenv

logger = logging.getLogger(__name__)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ .env —Ñ–∞–π–ª–∞
def load_env_file():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç .env —Ñ–∞–π–ª –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"""
    # –ü—É—Ç—å: app/services/ai_service.py -> app/services -> app -> –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
    project_root = Path(__file__).parent.parent.parent
    env_file = project_root / ".env"
    
    # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏ –Ω–∞ —Å–ª—É—á–∞–π –¥—Ä—É–≥–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    if not env_file.exists():
        # –ü—Ä–æ–±—É–µ–º —Ç–µ–∫—É—â—É—é —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        env_file = Path.cwd() / ".env"
        if not env_file.exists():
            # –ü—Ä–æ–±—É–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            env_file = Path.cwd().parent / ".env"
    
    if env_file.exists():
        load_dotenv(dotenv_path=env_file, override=True)
        logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω .env —Ñ–∞–π–ª: {env_file}")
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω
        api_key = os.getenv("DEEPSEEK_API_KEY")
        if api_key:
            logger.info(f"‚úÖ DEEPSEEK_API_KEY –Ω–∞–π–¥–µ–Ω: {api_key[:10]}...{api_key[-4:]} (–¥–ª–∏–Ω–∞: {len(api_key)})")
        else:
            logger.warning(f"‚ö†Ô∏è DEEPSEEK_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º .env —Ñ–∞–π–ª–µ!")
        return env_file
    else:
        # –ï—Å–ª–∏ .env –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        load_dotenv(override=True)
        logger.warning(f"‚ö†Ô∏è .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ {env_file}, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        return None

# –ó–∞–≥—Ä—É–∂–∞–µ–º .env —Ñ–∞–π–ª –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è
env_file = load_env_file()


class DeepSeekAIChatService:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI API.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç DeepSeek, Ollama (–ª–æ–∫–∞–ª—å–Ω–æ, –±–µ—Å–ø–ª–∞—Ç–Ω–æ) –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ httpx –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
    """
    def __init__(self):
        # –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–ï–ú .env —Ñ–∞–π–ª –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏
        load_env_file()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ AI (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ollama –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
        self.provider = os.getenv("AI_PROVIDER", "ollama").lower()
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á API (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
        self.api_key = os.getenv("DEEPSEEK_API_KEY") or os.getenv("OPENAI_API_KEY")
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ URL –∏ –º–æ–¥–µ–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        if self.provider == "ollama":
            # Ollama - –ª–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å, –ø–æ–ª–Ω–æ—Å—Ç—å—é –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è
            self.api_url = os.getenv("OLLAMA_API_URL", "http://localhost:11434/v1/chat/completions")
            self.model = os.getenv("OLLAMA_MODEL", "llama3.2")  # –∏–ª–∏ llama3.1, mistral, qwen2.5 –∏ –¥—Ä.
            self.api_key = None  # Ollama –Ω–µ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á
            logger.info(f"ü§ñ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Ollama (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å)")
            logger.info(f"   URL: {self.api_url}")
            logger.info(f"   –ú–æ–¥–µ–ª—å: {self.model}")
            logger.info(f"   üí° –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Ollama: https://ollama.com/")
            logger.info(f"   üí° –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ: ollama pull {self.model}")
        elif self.provider == "deepseek":
            # DeepSeek API (–ø–ª–∞—Ç–Ω—ã–π, —Ç—Ä–µ–±—É–µ—Ç –±–∞–ª–∞–Ω—Å)
            default_url = "https://api.deepseek.com/v1/chat/completions"
            self.api_url = os.getenv("DEEPSEEK_API_URL", default_url)
            self.model = os.getenv("DEEPSEEK_MODEL", "deepseek-chat")
            
            # –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—é—á–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–ª—é—á)
            if self.api_key:
                logger.info(f"‚úÖ DeepSeek API –∫–ª—é—á –Ω–∞–π–¥–µ–Ω: {self.api_key[:10]}...{self.api_key[-4:]} (–¥–ª–∏–Ω–∞: {len(self.api_key)})")
                if not self.api_key.startswith("sk-"):
                    logger.warning(f"‚ö†Ô∏è –ö–ª—é—á –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 'sk-', –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –Ω–µ –≤–∞–ª–∏–¥–Ω—ã–π –∫–ª—é—á!")
            else:
                logger.error("‚ùå DeepSeek API –∫–ª—é—á –ù–ï –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
                logger.error(f"   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞")
                logger.error(f"   üí° –î–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ AI_PROVIDER=ollama –≤ .env")
        else:
            # –î—Ä—É–≥–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, OpenAI —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ)
            self.api_url = os.getenv("AI_API_URL", "https://api.openai.com/v1/chat/completions")
            self.model = os.getenv("AI_MODEL", "gpt-3.5-turbo")
            if not self.api_key:
                logger.warning(f"‚ö†Ô∏è API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ {self.provider}")
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏
        self.max_retries = int(os.getenv("AI_MAX_RETRIES", "3"))
        self.timeout = int(os.getenv("AI_TIMEOUT", "60"))
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç httpx –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        self._client: Optional[httpx.AsyncClient] = None
        
        logger.info(f"AI Service –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–∞–π–¥–µ—Ä: {self.provider}, –ú–æ–¥–µ–ª—å: {self.model}, URL: {self.api_url}")
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        if self.provider == "deepseek" and not self.api_key:
            logger.warning("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: DEEPSEEK_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
            logger.warning(f"   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞: {env_file}")
            logger.warning(f"   üí° –î–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ AI_PROVIDER=ollama")

        # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ (–∫–∞–∫ –≤ –¢–ó)
        self.templates = {
            "transit_analysis": {
                "name": "–ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞–Ω–∑–∏—Ç–æ–≤ –¥–ª—è —Å—Ñ–µ—Ä—ã –∂–∏–∑–Ω–∏",
                "description": "–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–∞–Ω–∑–∏—Ç–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ñ–µ—Ä—ã –∂–∏–∑–Ω–∏",
                "system_prompt": """–¢—ã –æ–ø—ã—Ç–Ω—ã–π –∞—Å—Ç—Ä–æ–ø—Å–∏—Ö–æ–ª–æ–≥. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–∞–Ω–∑–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ñ–µ—Ä—ã –∂–∏–∑–Ω–∏.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–°–û–ë–õ–Æ–î–ê–ô –°–¢–†–û–ì–û):
1. üí´ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è - –Ω–∞—á–Ω–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è
2. üîç –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—Ä—Ç—ã - –ø–ª–∞–Ω–µ—Ç—ã, –¥–æ–º–∞, –∞—Å–ø–µ–∫—Ç—ã
3. üèõÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—ã—Ç–∞ —á–µ—Ä–µ–∑ –∞—Ä—Ö–µ—Ç–∏–ø—ã 
4. üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç–Ω–µ—Ä–≥–∏–µ–π - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
5. üìà –ü—Ä–æ–≥–Ω–æ–∑ –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ - —á—Ç–æ –∂–¥–∞—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è
6. üåü –£–≥–ª—É–±–ª—è—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - —á—Ç–æ –∏–∑—É—á–∏—Ç—å –¥–∞–ª—å—à–µ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)

–ë—É–¥—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –∏ –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏."""
            },
            "relationship_synastry": {
                "name": "–°–∏–Ω–∞—Å—Ç—Ä–∏—è –¥–ª—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π",
                "description": "–ê–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –¥—Ä—É–≥–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º",
                "system_prompt": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∏–Ω–∞—Å—Ç—Ä–∏–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ —É–∫–∞–∑–∞–Ω–Ω—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–°–û–ë–õ–Æ–î–ê–ô –°–¢–†–û–ì–û):
1. üí´ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–π
2. üîç –ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Å–∏–Ω–∞—Å—Ç—Ä–∏–∏ (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –∫–≤–∞–¥—Ä–∞—Ç—ã, —Ç—Ä–∏–Ω—ã)
3. üèõÔ∏è –ê—Ä—Ö–µ—Ç–∏–ø–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–∑–∞–∏–º–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π
4. üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
5. üìà –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π
6. üåü –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–≤—è–∑–∏"""
            },
            "daily_forecast": {
                "name": "–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑",
                "description": "–ü–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å",
                "system_prompt": """–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥-–ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç–µ–ª—å. –î–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–µ–Ω—å.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–°–û–ë–õ–Æ–î–ê–ô –°–¢–†–û–ì–û):
1. üí´ –û–±—â–∞—è —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ –¥–Ω—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏–π
2. üîç –ö–ª—é—á–µ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∏—Ç—ã –∏ –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Å—Ñ–µ—Ä—ã
3. üèõÔ∏è –ê—Ä—Ö–µ—Ç–∏–ø—ã –¥–Ω—è - –∫–∞–∫–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã
4. üõ†Ô∏è –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π
5. üìà –í–æ–∑–º–æ–∂–Ω—ã–µ challenges –∏ –∫–∞–∫ –∏—Ö –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å
6. üåü –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –¥–Ω—è"""
            },
            "emergency_support": {
                "name": "–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞",
                "description": "–°—Ä–æ—á–Ω–∞—è –ø–æ–º–æ—â—å –≤ —Å—Ç—Ä–µ—Å—Å–æ–≤–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏",
                "system_prompt": """–¢—ã —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –∞—Å—Ç—Ä–æ–ø—Å–∏—Ö–æ–ª–æ–≥, –æ–∫–∞–∑—ã–≤–∞—é—â–∏–π —ç–∫—Å—Ç—Ä–µ–Ω–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–°–û–ë–õ–Æ–î–ê–ô –°–¢–†–û–ì–û):
1. üí´ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
2. üîç –ê–Ω–∞–ª–∏–∑ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–∏—Ç—É–∞—Ü–∏–∏
3. üèõÔ∏è –ü–æ–Ω–∏–º–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∞—Ä—Ö–µ—Ç–∏–ø–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
4. üõ†Ô∏è –¢–µ—Ö–Ω–∏–∫–∏ –¥–ª—è —Å–Ω—è—Ç–∏—è –æ—Å—Ç—Ä–æ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞ - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏
5. üìà –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏
6. üåü –†–µ—Å—É—Ä—Å—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏"""
            },
            "decision_making": {
                "name": "–ü–æ–º–æ—â—å –≤ –ø—Ä–∏–Ω—è—Ç–∏–∏ —Ä–µ—à–µ–Ω–∏—è",
                "description": "–ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π",
                "system_prompt": """–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø—Ä–∏–Ω—è—Ç–∏—é —Ä–µ—à–µ–Ω–∏–π. –ü–æ–º–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏–Ω—è—Ç—å –≤–∞–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–°–û–ë–õ–Æ–î–ê–ô –°–¢–†–û–ì–û):
1. üí´ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ —Å–ª–æ–∂–Ω–æ–º –≤—ã–±–æ—Ä–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–º–Ω–µ–Ω–∏–π
2. üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–∞–Ω–∑–∏—Ç–æ–≤ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
3. üèõÔ∏è –ê—Ä—Ö–µ—Ç–∏–ø—ã –≤—ã–±–æ—Ä–∞ –∏ –∏—Ö –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ
4. üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
5. üìà –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ - –∫–æ–≥–¥–∞ –ª—É—á—à–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å
6. üåü –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤"""
            },
            "natal_analysis": {
                "name": "–ê–Ω–∞–ª–∏–∑ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã",
                "description": "–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                "system_prompt": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–∞—Ç–∞–ª—å–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–°–û–ë–õ–Æ–î–ê–ô –°–¢–†–û–ì–û):
1. üí´ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –æ–±—â–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç—ã
2. üîç –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –∞—Å–ø–µ–∫—Ç—ã
3. üèõÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –∞—Ä—Ö–µ—Ç–∏–ø—ã –∏ –∏—Ö –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ
4. üõ†Ô∏è –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏ –∑–æ–Ω—ã —Ä–æ—Å—Ç–∞
5. üìà –ñ–∏–∑–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
6. üåü –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞"""
            },
            "elective": {
                "name": "–≠–ª–µ–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ (–≤—ã–±–æ—Ä –¥–∞—Ç—ã)",
                "description": "–ü–æ–¥–±–æ—Ä –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã—Ö –¥–∞—Ç –¥–ª—è —Å–æ–±—ã—Ç–∏–π",
                "system_prompt": """–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —ç–ª–µ–∫—Ç–∏–≤–Ω–æ–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏. –ü–æ–º–æ–≥–∏ –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à—É—é –¥–∞—Ç—É.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–°–û–ë–õ–Æ–î–ê–ô –°–¢–†–û–ì–û):
1. üí´ –ü–æ–Ω–∏–º–∞–Ω–∏–µ –≤–∞–∂–Ω–æ—Å—Ç–∏ —Å–æ–±—ã—Ç–∏—è
2. üîç –ê–Ω–∞–ª–∏–∑ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
3. üèõÔ∏è –ê—Ä—Ö–µ—Ç–∏–ø—ã –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤
4. üõ†Ô∏è –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞
5. üìà –ß—Ç–æ —É—á–µ—Å—Ç—å –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
6. üåü –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã"""
            },
            "retrospective": {
                "name": "–†–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑",
                "description": "–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—à–ª—ã—Ö —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—é",
                "system_prompt": """–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥-–∞–Ω–∞–ª–∏—Ç–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ—à–ª—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–°–û–ë–õ–Æ–î–ê–ô –°–¢–†–û–ì–û):
1. üí´ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–∂–∏—Ç–æ–≥–æ –æ–ø—ã—Ç–∞
2. üîç –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–∏–æ–¥–∞
3. üèõÔ∏è –ê—Ä—Ö–µ—Ç–∏–ø–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–∫–∏ —Å–∏—Ç—É–∞—Ü–∏–∏
4. üõ†Ô∏è –ò–Ω—Å–∞–π—Ç—ã –¥–ª—è –±—É–¥—É—â–µ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
5. üìà –°–≤—è–∑—å —Å —Ç–µ–∫—É—â–∏–º–∏ —Ç—Ä–∞–Ω–∑–∏—Ç–∞–º–∏
6. üåü –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–ø—ã—Ç–∞"""
            },
            "career_strategy": {
                "name": "–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—å–µ—Ä—ã",
                "description": "–ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏",
                "system_prompt": """–¢—ã –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥-—Å—Ç—Ä–∞—Ç–µ–≥. –ü–æ–º–æ–≥–∏ —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞—Ä—å–µ—Ä—ã.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–°–û–ë–õ–Æ–î–ê–ô –°–¢–†–û–ì–û):
1. üí´ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–µ–º–ª–µ–Ω–∏–π
2. üîç –ê–Ω–∞–ª–∏–∑ 10 –¥–æ–º–∞ –∏ —É–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π –∫–∞—Ä—å–µ—Ä—ã
3. üèõÔ∏è –ê—Ä—Ö–µ—Ç–∏–ø—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
4. üõ†Ô∏è –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –∫–∞—Ä—å–µ—Ä—ã
5. üìà –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –¥–ª—è –∫–∞—Ä—å–µ—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
6. üåü –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏"""
            },
            "affirmations": {
                "name": "–ü–æ–¥–±–æ—Ä –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–π –∏ —Ä–∏—Ç—É–∞–ª–æ–≤",
                "description": "–°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫",
                "system_prompt": """–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥-–ø—Ä–∞–∫—Ç–∏–∫. –°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏ –∏ —Ä–∏—Ç—É–∞–ª—ã.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–°–û–ë–õ–Æ–î–ê–ô –°–¢–†–û–ì–û):
1. üí´ –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞
2. üîç –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏–∫
3. üèõÔ∏è –ê—Ä—Ö–µ—Ç–∏–ø—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã
4. üõ†Ô∏è –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏ –∏ —Ä–∏—Ç—É–∞–ª—ã
5. üìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –ø—Ä–∞–∫—Ç–∏–∫
6. üåü –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è"""
            }
        }

    async def _get_client(self) -> httpx.AsyncClient:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞"""
        if self._client is None:
            self._client = httpx.AsyncClient(
                timeout=httpx.Timeout(self.timeout, connect=10.0),
                limits=httpx.Limits(max_keepalive_connections=10, max_connections=20)
            )
        return self._client
    
    async def _close_client(self):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ HTTP –∫–ª–∏–µ–Ω—Ç–∞"""
        if self._client is not None:
            await self._client.aclose()
            self._client = None

    def build_system_prompt(self,
                            user_data: Dict,
                            template_type: Optional[str] = None,
                            context_entries: List[Dict] = None,
                            mentioned_contacts: List[Dict] = None) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"""

        base_prompt = """–¢—ã –ò–ò-–∞—Å—Ç—Ä–æ–ø—Å–∏—Ö–æ–ª–æ–≥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ "–ê—Å—Ç–æ–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è". –¢–≤–æ—è —Ä–æ–ª—å - —Å–æ—á–µ—Ç–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∞ –∏ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞.

–û–°–ù–û–í–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
- –í—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ –∏–∑ 6 –ø—É–Ω–∫—Ç–æ–≤
- –ù–∞—á–∏–Ω–∞–π –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≥–ª—É–±–∏–Ω–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è
- –î–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ, –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ë—É–¥—å –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

"""

        # –î–æ–±–∞–≤–ª—è–µ–º —à–∞–±–ª–æ–Ω –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
        if template_type and template_type in self.templates:
            base_prompt += f"\n{self.templates[template_type]['system_prompt']}\n"
        else:
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –µ—Å–ª–∏ —à–∞–±–ª–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω
            base_prompt += """
–°–¢–ê–ù–î–ê–†–¢–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (—Å–æ–±–ª—é–¥–∞–π —Å—Ç—Ä–æ–≥–æ):
1. üí´ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
2. üîç –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—Ä—Ç—ã
3. üèõÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—ã—Ç–∞ —á–µ—Ä–µ–∑ –∞—Ä—Ö–µ—Ç–∏–ø—ã  
4. üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç–Ω–µ—Ä–≥–∏–µ–π
5. üìà –ü—Ä–æ–≥–Ω–æ–∑ –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞
6. üåü –£–≥–ª—É–±–ª—è—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)
"""

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        base_prompt += f"""

–î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
- –ò–º—è: {user_data.get('name', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}
- –°–æ–ª–Ω–µ—á–Ω—ã–π –∑–Ω–∞–∫: {user_data.get('sun_sign', '–Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω')}
- –ó–Ω–∞–∫ –ª—É–Ω—ã: {user_data.get('moon_sign', '–Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω')}
- –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç: {user_data.get('ascendant_sign', '–Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω')}
"""

        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        if context_entries:
            base_prompt += "\n–†–ï–õ–ï–í–ê–ù–¢–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ò–°–¢–û–†–ò–ò:\n"
            for entry in context_entries[:3]:  # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∑–∞–ø–∏—Å–∏
                if entry.get('insight'):
                    base_prompt += f"- {entry['insight']}\n"
                if entry.get('successful_strategy'):
                    base_prompt += f"- –£—Å–ø–µ—à–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: {entry['successful_strategy']}\n"

        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö
        if mentioned_contacts:
            base_prompt += "\n–£–ü–û–ú–Ø–ù–£–¢–´–ï –ö–û–ù–¢–ê–ö–¢–´ –î–õ–Ø –°–ò–ù–ê–°–¢–†–ò–ß–ï–°–ö–û–ì–û –ê–ù–ê–õ–ò–ó–ê:\n"
            for contact in mentioned_contacts:
                base_prompt += f"- {contact['name']} ({contact['relationship_type']}): –°–æ–ª–Ω—Ü–µ –≤ {contact.get('sun_sign', '–Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω')}\n"

        base_prompt += """

–í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ —Å–æ–±–ª—é–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ –∏–∑ 6 –ø—É–Ω–∫—Ç–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø—É–Ω–∫—Ç–æ–≤.
–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å —Ç–µ–ø–ª—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º."""

        return base_prompt

    async def _make_request_with_retry(self, payload: Dict, headers: Dict) -> Dict:
        """
        –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
        
        Args:
            payload: –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
            headers: –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
            
        Returns:
            –û—Ç–≤–µ—Ç –æ—Ç API –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
            
        Raises:
            httpx.HTTPStatusError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö API (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫)
            httpx.RequestError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫)
        """
        client = await self._get_client()
        last_error = None
        
        for attempt in range(1, self.max_retries + 1):
            try:
                logger.debug(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt}/{self.max_retries} –∑–∞–ø—Ä–æ—Å–∞ –∫ DeepSeek API")
                response = await client.post(
                    self.api_url,
                    headers=headers,
                    json=payload
                )
                response.raise_for_status()
                return response.json()
                
            except httpx.TimeoutException as e:
                last_error = e
                if attempt < self.max_retries:
                    wait_time = attempt * 2  # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                    logger.warning(f"–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–ø—ã—Ç–∫–∞ {attempt}/{self.max_retries}). –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time}—Å")
                    await asyncio.sleep(wait_time)
                else:
                    logger.error(f"–¢–∞–π–º–∞—É—Ç –ø–æ—Å–ª–µ {self.max_retries} –ø–æ–ø—ã—Ç–æ–∫")
                    raise
                    
            except httpx.HTTPStatusError as e:
                # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                error_details = {
                    "status_code": e.response.status_code,
                    "url": self.api_url,
                    "model": self.model,
                    "response_text": e.response.text[:500] if e.response.text else "–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞"
                }
                logger.error(f"HTTP –æ—à–∏–±–∫–∞: {error_details}")
                
                # –î–ª—è –æ—à–∏–±–æ–∫ API (4xx, 5xx) –Ω–µ –¥–µ–ª–∞–µ–º retry, –∫—Ä–æ–º–µ 429 (rate limit) –∏ 5xx
                if e.response.status_code == 429:
                    # Rate limit - –¥–µ–ª–∞–µ–º retry —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                    if attempt < self.max_retries:
                        wait_time = attempt * 5
                        logger.warning(f"Rate limit (–ø–æ–ø—ã—Ç–∫–∞ {attempt}/{self.max_retries}). –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time}—Å")
                        await asyncio.sleep(wait_time)
                        continue
                    raise
                elif 500 <= e.response.status_code < 600:
                    # –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏ - –¥–µ–ª–∞–µ–º retry
                    last_error = e
                    if attempt < self.max_retries:
                        wait_time = attempt * 2
                        logger.warning(f"–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ {e.response.status_code} (–ø–æ–ø—ã—Ç–∫–∞ {attempt}/{self.max_retries}). –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time}—Å")
                        await asyncio.sleep(wait_time)
                        continue
                    raise
                elif e.response.status_code == 402:
                    # 402 - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ
                    error_text = e.response.text[:500] if e.response.text else "–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–∫–∏"
                    logger.error(f"402 –æ—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ DeepSeek")
                    logger.error(f"–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {error_text}")
                    logger.error("üí° –†–µ—à–µ–Ω–∏–µ:")
                    logger.error("   1. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ https://platform.deepseek.com/")
                    logger.error("   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API")
                    raise
                elif e.response.status_code == 404:
                    # 404 - –æ—à–∏–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω —Ä–µ—Å—É—Ä—Å (–º–æ–¥–µ–ª—å –∏–ª–∏ endpoint)
                    error_text = e.response.text[:500] if e.response.text else "–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–∫–∏"
                    logger.error(f"404 –æ—à–∏–±–∫–∞: –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. URL: {self.api_url}, –ú–æ–¥–µ–ª—å: {self.model}")
                    logger.error(f"–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {error_text}")
                    logger.error("üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
                    logger.error("   1. –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: deepseek-chat –∏–ª–∏ deepseek-reasoner)")
                    logger.error("   2. –ù–µ–≤–µ—Ä–Ω—ã–π URL endpoint (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ DEEPSEEK_API_URL –≤ .env)")
                    logger.error("   3. API –∫–ª—é—á –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏")
                    raise
                else:
                    # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (4xx –∫—Ä–æ–º–µ 429 –∏ 404) - –Ω–µ –¥–µ–ª–∞–µ–º retry
                    logger.error(f"–û—à–∏–±–∫–∞ API: {e.response.status_code} - {e.response.text}")
                    raise
                    
            except httpx.RequestError as e:
                # –û—à–∏–±–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è - –¥–µ–ª–∞–µ–º retry
                last_error = e
                if attempt < self.max_retries:
                    wait_time = attempt * 2
                    logger.warning(f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–ø–æ–ø—ã—Ç–∫–∞ {attempt}/{self.max_retries}): {str(e)}. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time}—Å")
                    await asyncio.sleep(wait_time)
                else:
                    logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ {self.max_retries} –ø–æ–ø—ã—Ç–æ–∫")
                    raise
                    
            except Exception as e:
                logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ DeepSeek API: {str(e)}", exc_info=True)
                raise
        
        # –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞, –∑–Ω–∞—á–∏—Ç –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
        if last_error:
            raise last_error
        raise Exception("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞")

    async def generate_response(self,
                                user_message: str,
                                user_data: Dict,
                                template_type: Optional[str] = None,
                                context_entries: List[Dict] = None,
                                mentioned_contacts: List[Dict] = None) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ DeepSeek API —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        
        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_data: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–º—è, –∑–Ω–∞–∫–∏ –∑–æ–¥–∏–∞–∫–∞)
            template_type: –¢–∏–ø —à–∞–±–ª–æ–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            context_entries: –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
            mentioned_contacts: –£–ø–æ–º—è–Ω—É—Ç—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–∏–Ω–∞—Å—Ç—Ä–∏–∏
            
        Returns:
            –û—Ç–≤–µ—Ç –æ—Ç –ò–ò
        """
        # –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–ï–ú –∫–ª—é—á –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏
        self.reload_api_key()
        
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –µ–≥–æ —Ç—Ä–µ–±—É—é—Ç
            if self.provider == "deepseek" and not self.api_key:
                logger.error("API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
                return "‚ùå –û—à–∏–±–∫–∞: API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ DEEPSEEK_API_KEY –≤ —Ñ–∞–π–ª .env –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ AI_PROVIDER=ollama –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞"

            system_prompt = self.build_system_prompt(
                user_data, template_type, context_entries, mentioned_contacts
            )

            headers = {
                "Content-Type": "application/json"
            }
            # –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω API –∫–ª—é—á
            if self.api_key:
                headers["Authorization"] = f"Bearer {self.api_key}"

            payload = {
                "model": self.model,
                "messages": [
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_message}
                ],
                "temperature": 0.7,
                "max_tokens": 2000,
                "stream": False
            }

            logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ AI API ({self.provider}). –ú–æ–¥–µ–ª—å: {self.model}, –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: {len(user_message)}")
            
            result = await self._make_request_with_retry(payload, headers)
            
            response_text = result["choices"][0]["message"]["content"]
            logger.info(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç AI API ({self.provider}). –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(response_text)}")
            
            return response_text

        except httpx.TimeoutException:
            logger.error(f"–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ AI API ({self.provider})")
            return "‚è∞ –ò–∑–≤–∏–Ω–∏—Ç–µ, –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
        except httpx.HTTPStatusError as e:
            # –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–ï–ú –∫–ª—é—á –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–∫–∏
            self.reload_api_key()
            
            error_msg = f"–û—à–∏–±–∫–∞ API ({self.provider}): {e.response.status_code}"
            
            # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            if e.response.status_code == 402:
                error_text = e.response.text[:300] if e.response.text else "–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π"
                logger.error(f"402: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞. URL: {self.api_url}, –ú–æ–¥–µ–ª—å: {self.model}")
                logger.error(f"–û—Ç–≤–µ—Ç: {error_text}")
                if self.provider == "deepseek":
                    error_msg = f"–û—à–∏–±–∫–∞ 402: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ DeepSeek. " \
                               f"–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ https://platform.deepseek.com/ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ AI_PROVIDER=ollama –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞"
                else:
                    error_msg = f"–û—à–∏–±–∫–∞ 402: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –∞–∫–∫–∞—É–Ω—Ç–∞."
            
            elif e.response.status_code == 404:
                error_text = e.response.text[:300] if e.response.text else "–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π"
                logger.error(f"404: –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. URL: {self.api_url}, –ú–æ–¥–µ–ª—å: {self.model}")
                logger.error(f"–û—Ç–≤–µ—Ç: {error_text}")
                if self.provider == "ollama":
                    error_msg = f"–û—à–∏–±–∫–∞ 404: –ú–æ–¥–µ–ª—å {self.model} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Ollama. " \
                               f"–ó–∞–≥—Ä—É–∑–∏—Ç–µ –º–æ–¥–µ–ª—å: ollama pull {self.model}. " \
                               f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω–∞: ollama serve"
                elif self.provider == "deepseek":
                    error_msg = f"–û—à–∏–±–∫–∞ 404: –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–º—è –º–æ–¥–µ–ª–∏ ({self.model}) –∏ URL endpoint. " \
                               f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: deepseek-chat –∏–ª–∏ deepseek-reasoner"
                else:
                    error_msg = f"–û—à–∏–±–∫–∞ 404: –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–º—è –º–æ–¥–µ–ª–∏ ({self.model}) –∏ URL endpoint."
            
            elif e.response.status_code == 401:
                # –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—é—á–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
                key_info = f"{self.api_key[:10]}...{self.api_key[-4:]}" if self.api_key else "–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù"
                env_file_path = Path(__file__).parent.parent.parent / ".env"
                
                # –ß–∏—Ç–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ .env —Ñ–∞–π–ª–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                actual_key_from_file = None
                if env_file_path.exists():
                    try:
                        with open(env_file_path, 'r', encoding='utf-8') as f:
                            for line in f:
                                if line.strip().startswith('DEEPSEEK_API_KEY='):
                                    actual_key_from_file = line.split('=', 1)[1].strip()
                                    break
                    except Exception as read_err:
                        logger.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è .env —Ñ–∞–π–ª–∞: {read_err}")
                
                logger.error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401). –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–ª—é—á: {key_info}")
                logger.error(f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env: {env_file_path}")
                if actual_key_from_file:
                    file_key_info = f"{actual_key_from_file[:10]}...{actual_key_from_file[-4:]}" if len(actual_key_from_file) > 4 else actual_key_from_file
                    logger.error(f"–í .env —Ñ–∞–π–ª–µ —Ä–µ–∞–ª—å–Ω–æ: {file_key_info}")
                    if 'your' in actual_key_from_file.lower() or 'placeholder' in actual_key_from_file.lower():
                        logger.error("‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –í .env —Ñ–∞–π–ª–µ —Å—Ç–æ–∏—Ç –ó–ê–ì–õ–£–®–ö–ê! –ó–∞–º–µ–Ω–∏—Ç–µ 'your_deeps...here' –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á sk-888019144c984d878303305ae31095a9")
                
                error_msg = f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á. (–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–ª—é—á: {key_info})"
            elif e.response.status_code == 429:
                error_msg = "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ."
            elif e.response.status_code >= 500:
                error_msg = "–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ DeepSeek. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            logger.error(f"{error_msg} - {e.response.text}")
            return f"üîß {error_msg}"
        except httpx.RequestError as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI API ({self.provider}): {str(e)}")
            if self.provider == "ollama":
                return f"üîß –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Ollama. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω–∞: ollama serve. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL: {self.api_url}"
            return f"üîß –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
        except Exception as e:
            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {str(e)}", exc_info=True)
            return f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}"

    def get_available_templates(self) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤"""
        return [
            {
                "id": template_id,
                "name": template_data["name"],
                "description": template_data["description"],
                "prompt_hint": template_data["system_prompt"][:150] + "..."
            }
            for template_id, template_data in self.templates.items()
        ]
    
    async def chat(self, message: str, system_prompt: Optional[str] = None) -> str:
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —á–∞—Ç-–∑–∞–ø—Ä–æ—Å–æ–≤ (–±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        
        Args:
            message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            system_prompt: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            
        Returns:
            –û—Ç–≤–µ—Ç –ò–ò
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –µ–≥–æ —Ç—Ä–µ–±—É—é—Ç
            if self.provider == "deepseek" and not self.api_key:
                logger.error("API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
                return "‚ùå –û—à–∏–±–∫–∞: API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            
            messages = []
            if system_prompt:
                messages.append({"role": "system", "content": system_prompt})
            messages.append({"role": "user", "content": message})
            
            headers = {
                "Content-Type": "application/json"
            }
            # –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω API –∫–ª—é—á
            if self.api_key:
                headers["Authorization"] = f"Bearer {self.api_key}"
            
            payload = {
                "model": self.model,
                "messages": messages,
                "temperature": 0.7,
                "max_tokens": 1000,
                "stream": False
            }
            
            result = await self._make_request_with_retry(payload, headers)
            return result["choices"][0]["message"]["content"]
            
        except httpx.TimeoutException:
            logger.error("–¢–∞–π–º–∞—É—Ç –≤ chat –º–µ—Ç–æ–¥–µ")
            return "‚è∞ –ò–∑–≤–∏–Ω–∏—Ç–µ, –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –∏—Å—Ç–µ–∫–ª–æ."
        except httpx.HTTPStatusError as e:
            logger.error(f"–û—à–∏–±–∫–∞ API –≤ chat –º–µ—Ç–æ–¥–µ: {e.response.status_code}")
            return f"üîß –û—à–∏–±–∫–∞ API: {e.response.status_code}"
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ chat –º–µ—Ç–æ–¥–µ: {str(e)}", exc_info=True)
            return f"–û—à–∏–±–∫–∞: {str(e)}"


    def chat_sync(self, message: str, system_prompt: Optional[str] = None) -> str:
        """
        –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è chat –º–µ—Ç–æ–¥–∞.
        –ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥ –¥–∞–∂–µ –µ—Å–ª–∏ event loop —É–∂–µ –∑–∞–ø—É—â–µ–Ω.
        
        Args:
            message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            system_prompt: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            
        Returns:
            –û—Ç–≤–µ—Ç –ò–ò
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–π event loop
            try:
                loop = asyncio.get_running_loop()
                # –ï—Å–ª–∏ event loop —É–∂–µ –∑–∞–ø—É—â–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ —Å –Ω–æ–≤—ã–º event loop
                
                result = None
                exception = None
                
                def run_in_thread():
                    nonlocal result, exception
                    try:
                        new_loop = asyncio.new_event_loop()
                        asyncio.set_event_loop(new_loop)
                        result = new_loop.run_until_complete(self.chat(message, system_prompt))
                        new_loop.close()
                    except Exception as e:
                        exception = e
                
                thread = threading.Thread(target=run_in_thread)
                thread.start()
                thread.join()
                
                if exception:
                    raise exception
                return result
            except RuntimeError:
                # Event loop –Ω–µ –∑–∞–ø—É—â–µ–Ω, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å asyncio.run
                return asyncio.run(self.chat(message, system_prompt))
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ chat_sync –º–µ—Ç–æ–¥–µ: {str(e)}", exc_info=True)
            return f"–û—à–∏–±–∫–∞: {str(e)}"


    def reload_api_key(self):
        """–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç API –∫–ª—é—á –∏–∑ .env —Ñ–∞–π–ª–∞"""
        load_env_file()
        if self.provider == "deepseek":
            new_key = os.getenv("DEEPSEEK_API_KEY")
        else:
            new_key = os.getenv("DEEPSEEK_API_KEY") or os.getenv("OPENAI_API_KEY")
        
        if new_key != self.api_key:
            logger.info(f"üîÑ API –∫–ª—é—á –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω: {new_key[:10]}...{new_key[-4:] if new_key else '–ù–ï–¢'}")
            self.api_key = new_key
        return self.api_key


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
ai_service = DeepSeekAIChatService()